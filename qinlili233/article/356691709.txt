绕过51CTO的强制绑定微信
<p data-pid="HdLbjjli">不知道从什么时候开始51CTO的免费课强制绑定微信才能学了</p><figure data-size="normal"><noscript><img src="https://pica.zhimg.com/v2-3877a031fa31843343023228d4a77327_720w.jpg?source=3af55fa1" data-caption="" data-size="normal" data-rawwidth="2412" data-rawheight="1154" class="origin_image zh-lightbox-thumb" width="2412" data-original="https://pic1.zhimg.com/v2-3877a031fa31843343023228d4a77327_r.jpg?source=3af55fa1"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='2412'%20height='1154'&gt;&lt;/svg&gt;" data-caption="" data-size="normal" data-rawwidth="2412" data-rawheight="1154" class="origin_image zh-lightbox-thumb lazy" width="2412" data-original="https://pic1.zhimg.com/v2-3877a031fa31843343023228d4a77327_r.jpg?source=3af55fa1" data-actualsrc="https://pica.zhimg.com/v2-3877a031fa31843343023228d4a77327_720w.jpg?source=3af55fa1"></figure><p data-pid="HHkc4afy">但我怎么可能为了学一个免费课去绑定微信呢</p><p data-pid="AbmEdJFo">F12,开干!</p><p><br></p><p data-pid="PiRXcyGQ">打开抓包,点击加入学习</p><figure data-size="normal"><noscript><img src="https://pica.zhimg.com/v2-51f5d99451128f9f9bfdd9a622b886f6_720w.jpg?source=3af55fa1" data-caption="" data-size="normal" data-rawwidth="1729" data-rawheight="531" class="origin_image zh-lightbox-thumb" width="1729" data-original="https://pic1.zhimg.com/v2-51f5d99451128f9f9bfdd9a622b886f6_r.jpg?source=3af55fa1"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='1729'%20height='531'&gt;&lt;/svg&gt;" data-caption="" data-size="normal" data-rawwidth="1729" data-rawheight="531" class="origin_image zh-lightbox-thumb lazy" width="1729" data-original="https://pic1.zhimg.com/v2-51f5d99451128f9f9bfdd9a622b886f6_r.jpg?source=3af55fa1" data-actualsrc="https://pica.zhimg.com/v2-51f5d99451128f9f9bfdd9a622b886f6_720w.jpg?source=3af55fa1"></figure><p data-pid="AKp26c2E">得到四个请求,第三个就是生成二维码的请求了</p><p data-pid="TQ5j0W5D">所以显然问题出在前两个请求上</p><p><br></p><p data-pid="alJ-hkw5">get-login-mobile经过分析是检查绑定手机号的,跳过,所以问题就在这个wechat-status上</p><p data-pid="_VJP77JW">我们很容易盲猜逻辑:检查是否绑定微信,如果不绑定就弹出二维码</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-fa55c4081b44dccabab6eb8add5b1b87_720w.jpg?source=3af55fa1" data-caption="" data-size="normal" data-rawwidth="1829" data-rawheight="982" class="origin_image zh-lightbox-thumb" width="1829" data-original="https://pic1.zhimg.com/v2-fa55c4081b44dccabab6eb8add5b1b87_r.jpg?source=3af55fa1"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='1829'%20height='982'&gt;&lt;/svg&gt;" data-caption="" data-size="normal" data-rawwidth="1829" data-rawheight="982" class="origin_image zh-lightbox-thumb lazy" width="1829" data-original="https://pic1.zhimg.com/v2-fa55c4081b44dccabab6eb8add5b1b87_r.jpg?source=3af55fa1" data-actualsrc="https://pic1.zhimg.com/v2-fa55c4081b44dccabab6eb8add5b1b87_720w.jpg?source=3af55fa1"></figure><p data-pid="2L42QsUB">把调用拉出来,判断逻辑肯定在加载之后,所以直接从Load往上看</p><p><br></p><p data-pid="kir15-nL">checkBind这个方法名字显然太明显了,直接跳转</p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-bf1e6da07b7acc7902c9be60522bee02_720w.jpg?source=3af55fa1" data-caption="" data-size="normal" data-rawwidth="1015" data-rawheight="549" class="origin_image zh-lightbox-thumb" width="1015" data-original="https://pic1.zhimg.com/v2-bf1e6da07b7acc7902c9be60522bee02_r.jpg?source=3af55fa1"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='1015'%20height='549'&gt;&lt;/svg&gt;" data-caption="" data-size="normal" data-rawwidth="1015" data-rawheight="549" class="origin_image zh-lightbox-thumb lazy" width="1015" data-original="https://pic1.zhimg.com/v2-bf1e6da07b7acc7902c9be60522bee02_r.jpg?source=3af55fa1" data-actualsrc="https://pic3.zhimg.com/v2-bf1e6da07b7acc7902c9be60522bee02_720w.jpg?source=3af55fa1"></figure><p data-pid="l8TpxnQg">好家伙没混淆,注释都在</p><p data-pid="Vb3bzREy">结合这个api返回的json里面有一个data属性,我没绑定的情况下返回的就是1</p><p data-pid="WZ5Uaj1R">这代码显而易见,根据注释就能看出,data为1则弹框,否则就调用callback</p><p data-pid="CnWKBrod">那么我们只要让代码顺利的走到callback就行了</p><p><br></p><p data-pid="dwtFyNt3">在if上下断点之后点击按钮</p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-b2e8bbd112af89bec398da2a8cddbdd2_720w.jpg?source=3af55fa1" data-caption="" data-size="normal" data-rawwidth="1812" data-rawheight="654" class="origin_image zh-lightbox-thumb" width="1812" data-original="https://pic1.zhimg.com/v2-b2e8bbd112af89bec398da2a8cddbdd2_r.jpg?source=3af55fa1"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='1812'%20height='654'&gt;&lt;/svg&gt;" data-caption="" data-size="normal" data-rawwidth="1812" data-rawheight="654" class="origin_image zh-lightbox-thumb lazy" width="1812" data-original="https://pic1.zhimg.com/v2-b2e8bbd112af89bec398da2a8cddbdd2_r.jpg?source=3af55fa1" data-actualsrc="https://pic3.zhimg.com/v2-b2e8bbd112af89bec398da2a8cddbdd2_720w.jpg?source=3af55fa1"></figure><p><br></p><p data-pid="5sZKPD40">json的结果就在右侧看到了</p><p data-pid="TPmLNa0q">把status改成除了1以外的任意数字</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-7c036c657c5d7d96001ec394cff76939_720w.jpg?source=3af55fa1" data-caption="" data-size="normal" data-rawwidth="643" data-rawheight="314" class="origin_image zh-lightbox-thumb" width="643" data-original="https://pic2.zhimg.com/v2-7c036c657c5d7d96001ec394cff76939_r.jpg?source=3af55fa1"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='643'%20height='314'&gt;&lt;/svg&gt;" data-caption="" data-size="normal" data-rawwidth="643" data-rawheight="314" class="origin_image zh-lightbox-thumb lazy" width="643" data-original="https://pic2.zhimg.com/v2-7c036c657c5d7d96001ec394cff76939_r.jpg?source=3af55fa1" data-actualsrc="https://pic1.zhimg.com/v2-7c036c657c5d7d96001ec394cff76939_720w.jpg?source=3af55fa1"></figure><p data-pid="uDaBMBF0">然后继续执行</p><p><br></p><p><br></p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-5d5eac351de0ad224e32d074152aff7f_720w.jpg?source=3af55fa1" data-caption="" data-size="normal" data-rawwidth="1272" data-rawheight="601" class="origin_image zh-lightbox-thumb" width="1272" data-original="https://pic1.zhimg.com/v2-5d5eac351de0ad224e32d074152aff7f_r.jpg?source=3af55fa1"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='1272'%20height='601'&gt;&lt;/svg&gt;" data-caption="" data-size="normal" data-rawwidth="1272" data-rawheight="601" class="origin_image zh-lightbox-thumb lazy" width="1272" data-original="https://pic1.zhimg.com/v2-5d5eac351de0ad224e32d074152aff7f_r.jpg?source=3af55fa1" data-actualsrc="https://pic2.zhimg.com/v2-5d5eac351de0ad224e32d074152aff7f_720w.jpg?source=3af55fa1"></figure><p data-pid="c0P-tMyE">大功告成!</p><p><br></p><p><br></p><p data-pid="ltpnli0A">就一个抓包一个断点的难度就想逼我下载注册微信?那必不可能!</p><p><br></p><p><br></p><hr><p data-pid="FQHjsLXF">阶段2:</p><p data-pid="23mNrvpO">每次都要手动断点,不行,太麻烦了,得写成脚本</p><p><br></p><p data-pid="C6CMYmyf">可是方法被包起来了,怎么办呢?</p><p><br></p><p data-pid="R2luFmMS">很简单,ajax请求本质还是xhr,我把所有xhr都给劫持掉不就行了么</p><div class="highlight"><pre><code class="language-text"><span></span>(function(open) {

    XMLHttpRequest.prototype.open = function(method, url, async, user, pass) {

//do sth
        open.call(this, method, url, async, user, pass);
    };

})(XMLHttpRequest.prototype.open);
</code></pre></div><p data-pid="lYEZwBky">用这段代码可以劫持所有xhr</p><p data-pid="CRuKVMfX">用github配合jsdelivr做一个返回114514的json,得到地址<a href="http://link.zhihu.com/?target=https%3A//cdn.jsdelivr.net/gh/qinlili23333/PageConnect%40master/51ctohook.json" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">cdn.jsdelivr.net/gh/qin</span><span class="invisible">lili23333/PageConnect@master/51ctohook.json</span><span class="ellipsis"></span></a></p><p data-pid="yrlK9Xpm">不难写出</p><div class="highlight"><pre><code class="language-text"><span></span>if(url.indexOf("wechat-status")&gt;0){
    url= "https://cdn.jsdelivr.net/gh/qinlili23333/PageConnect@master/51ctohook.json";
               }
</code></pre></div><p data-pid="zLFZWpJj">发现是检查绑定的api就劫持到我自己搭建的虚假json上</p><h2>然后你会发现CORS了</h2><p data-pid="QFj1BTDa">得换个办法</p><p data-pid="Hx0YAz7S">转成base64不就行了嘛</p><p data-pid="WKxabPxF">data:application/json;base64,eyJzdGF0dXMiOjEsIm1zZyI6IiIsImRhdGEiOjExNDUxNH0=</p><p><br></p><p data-pid="y9X2jU4I">得到油猴脚本如下</p><div class="highlight"><pre><code class="language-text"><span></span>(function() {
    'use strict';

    (function(open) {

    XMLHttpRequest.prototype.open = function(method, url, async, user, pass) {

if(url.indexOf("wechat-status")&gt;0){
    url= "data:application/json;base64,eyJzdGF0dXMiOjEsIm1zZyI6IiIsImRhdGEiOjExNDUxNH0=";
               }
        open.call(this, method, url, async, user, pass);
    };

})(XMLHttpRequest.prototype.open);
})();
</code></pre></div><p></p>