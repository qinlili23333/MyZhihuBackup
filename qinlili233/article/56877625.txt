京东金融窃取截图的简要分析（2）-我的截图为什么跑到了私有目录下
<p data-pid="eCuqkGnh">上回（<a href="https://zhuanlan.zhihu.com/p/56875556" class="internal"><span class="invisible">https://</span><span class="visible">zhuanlan.zhihu.com/p/56</span><span class="invisible">875556</span><span class="ellipsis"></span></a>）说到，这话displayFile很有意思</p><p data-pid="5oOmUGtb">我们先来扒一下这个方法</p><p data-pid="wBlXYPBg">这个JDImageLoader里面调用的这个方法如下</p><p data-pid="xEcUlY6q">.method public displayFile(Ljava/lang/String;Landroid/widget/ImageView;Lcom/nostra13/universalimageloader/core/DisplayImageOptions;)V</p><p data-pid="kD3l7q9B">.registers 6</p><p data-pid="1SsyxzC_">.prologue</p><p data-pid="ZrHCsxxS">new-instance v0, Ljava/lang/StringBuilder;</p><p data-pid="qlTO_QP7">invoke-direct {v0}, Ljava/lang/StringBuilder;-&gt;()V</p><p data-pid="CB5PYHrm">const-string/jumbo v1, "file://"</p><p data-pid="yZ3jkeEb">invoke-virtual {v0, v1}, Ljava/lang/StringBuilder;-&gt;append(Ljava/lang/String;)Ljava/lang/StringBuilder;</p><p data-pid="oUD3Zn8j">move-result-object v0</p><p data-pid="U9yiBLBv">invoke-virtual {v0, p1}, Ljava/lang/StringBuilder;-&gt;append(Ljava/lang/String;)Ljava/lang/StringBuilder;</p><p data-pid="ZVsuDCmO">move-result-object v0</p><p data-pid="-G3HbHeh">invoke-virtual {v0}, Ljava/lang/StringBuilder;-&gt;toString()Ljava/lang/String;</p><p data-pid="HZqD3NU1">move-result-object v0</p><p data-pid="PuNAZHV3">//截止到现在都是在获取uri</p><p data-pid="cTPtBLv7">invoke-virtual {p0, v0, p2, p3}, Lcom/jd/jrapp/library/imageloader/JDImageLoader;-&gt;displayLocalImage(Ljava/lang/String;Landroid/widget/ImageView;Lcom/nostra13/universalimageloader/core/DisplayImageOptions;)V</p><p data-pid="HkjKmSrR">//用开源库展示</p><p data-pid="VSR6m5yo">return-void</p><p data-pid="--z1lyJp">.end method</p><p data-pid="nS4yOWvK">似乎截止到现在，狗东的操作还没出现攻击性代码，看方法名判断是仅仅获取截图并显示</p><p data-pid="5bipz59K">但是显示之后为什么文件就跑狗东私有目录里去了？</p><p data-pid="UEa23vCJ">初步判断和开源库脱不开关系</p><p data-pid="igpOXl60">看到displayLocalImage这个方法，我们去找找</p><figure><noscript><img src="https://pic1.zhimg.com/v2-13da1ce0a0ff508718c93623d23f1324_720w.png?source=3af55fa1" data-rawwidth="984" data-rawheight="895" class="origin_image zh-lightbox-thumb" width="984" data-original="https://pica.zhimg.com/v2-13da1ce0a0ff508718c93623d23f1324_r.jpg?source=3af55fa1"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='984'%20height='895'&gt;&lt;/svg&gt;" data-rawwidth="984" data-rawheight="895" class="origin_image zh-lightbox-thumb lazy" width="984" data-original="https://pica.zhimg.com/v2-13da1ce0a0ff508718c93623d23f1324_r.jpg?source=3af55fa1" data-actualsrc="https://pic1.zhimg.com/v2-13da1ce0a0ff508718c93623d23f1324_720w.png?source=3af55fa1"></figure><p data-pid="ktUsf5-e">调用了另外一个displayLocalImage方法</p><p data-pid="O9OlWUW7">首先强烈谴责这种俄罗斯套娃式写法，点名批评！！！</p><p data-pid="gJZkDTR4">接着我们打开这个套娃看看</p><figure><noscript><img src="https://pic1.zhimg.com/v2-60958242912094ae508fc3e123d76612_720w.png?source=3af55fa1" data-rawwidth="956" data-rawheight="1064" class="origin_image zh-lightbox-thumb" width="956" data-original="https://pic1.zhimg.com/v2-60958242912094ae508fc3e123d76612_r.jpg?source=3af55fa1"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='956'%20height='1064'&gt;&lt;/svg&gt;" data-rawwidth="956" data-rawheight="1064" class="origin_image zh-lightbox-thumb lazy" width="956" data-original="https://pic1.zhimg.com/v2-60958242912094ae508fc3e123d76612_r.jpg?source=3af55fa1" data-actualsrc="https://pic1.zhimg.com/v2-60958242912094ae508fc3e123d76612_720w.png?source=3af55fa1"></figure><p data-pid="nmbPbzNE">调用了开源库displayImage方法</p><p data-pid="Cnz2V2su">精确定位，发现又是个套娃</p><figure><noscript><img src="https://pic1.zhimg.com/v2-caaef6da71946749190d1233ce623887_720w.png?source=3af55fa1" data-rawwidth="1080" data-rawheight="1920" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic3.zhimg.com/v2-caaef6da71946749190d1233ce623887_r.jpg?source=3af55fa1"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='1080'%20height='1920'&gt;&lt;/svg&gt;" data-rawwidth="1080" data-rawheight="1920" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic3.zhimg.com/v2-caaef6da71946749190d1233ce623887_r.jpg?source=3af55fa1" data-actualsrc="https://pic1.zhimg.com/v2-caaef6da71946749190d1233ce623887_720w.png?source=3af55fa1"></figure><p data-pid="QUEy9A0b">这套娃还不止一层</p><figure><noscript><img src="https://pic2.zhimg.com/v2-461317dde5f9a7cb401beb2513d17073_720w.png?source=3af55fa1" data-rawwidth="1080" data-rawheight="1920" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic1.zhimg.com/v2-461317dde5f9a7cb401beb2513d17073_r.jpg?source=3af55fa1"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='1080'%20height='1920'&gt;&lt;/svg&gt;" data-rawwidth="1080" data-rawheight="1920" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic1.zhimg.com/v2-461317dde5f9a7cb401beb2513d17073_r.jpg?source=3af55fa1" data-actualsrc="https://pic2.zhimg.com/v2-461317dde5f9a7cb401beb2513d17073_720w.png?source=3af55fa1"></figure><p data-pid="Svp4S6pX">有点意思，接着扒</p><p data-pid="gj7F-pgW">这会是一个极长的方法，应该对了</p><figure><noscript><img src="https://pic2.zhimg.com/v2-d79acce62c607827979473eef9f537d6_720w.png?source=3af55fa1" data-rawwidth="1080" data-rawheight="1920" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic1.zhimg.com/v2-d79acce62c607827979473eef9f537d6_r.jpg?source=3af55fa1"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='1080'%20height='1920'&gt;&lt;/svg&gt;" data-rawwidth="1080" data-rawheight="1920" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic1.zhimg.com/v2-d79acce62c607827979473eef9f537d6_r.jpg?source=3af55fa1" data-actualsrc="https://pic2.zhimg.com/v2-d79acce62c607827979473eef9f537d6_720w.png?source=3af55fa1"></figure><p data-pid="P15dzFLp">方法有点长，复制到一个新smali里看看</p><p data-pid="xdDSbwK6">为了加快分析我们把出现关键文件夹名称的两个类StorageUtils和DefaultConfigurationFactory放进去搜索</p><p data-pid="tCdFwE-t">可以得到这个</p><figure><noscript><img src="https://pic1.zhimg.com/v2-25b4cef356f022d7809f81ad68da917d_720w.png?source=3af55fa1" data-rawwidth="1080" data-rawheight="1920" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic2.zhimg.com/v2-25b4cef356f022d7809f81ad68da917d_r.jpg?source=3af55fa1"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='1080'%20height='1920'&gt;&lt;/svg&gt;" data-rawwidth="1080" data-rawheight="1920" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic2.zhimg.com/v2-25b4cef356f022d7809f81ad68da917d_r.jpg?source=3af55fa1" data-actualsrc="https://pic1.zhimg.com/v2-25b4cef356f022d7809f81ad68da917d_720w.png?source=3af55fa1"></figure><p data-pid="_3saG7lE">初步推断是用私有目录做缓存</p><br><p data-pid="GtRbBZDX">我们来看看这个方法createDiskCache</p><p data-pid="sIAS9WAY">.method public static createDiskCache(Landroid/content/Context;Lcom/nostra13/universalimageloader/cache/disc/naming/FileNameGenerator;JI)Lcom/nostra13/universalimageloader/cache/disc/DiskCache;</p><p data-pid="-219mgDN">    .registers 13</p><p data-pid="ddXELL9H">    invoke-static {p0}, Lcom/nostra13/universalimageloader/core/DefaultConfigurationFactory;-&gt;createReserveDiskCacheDir(Landroid/content/Context;)Ljava/io/File;</p><p data-pid="p1N-pSvo">    move-result-object v2</p><p data-pid="qFHoHNBw">//建立缓存路径，正是uil-images路径出现的原因</p><p data-pid="IhIPv0Dy">    const-wide/16 v0, 0x0</p><p data-pid="_uGQcYzv">    cmp-long v0, p2, v0</p><p data-pid="XOMXcHuP">    if-gtz v0, :cond_c</p><p data-pid="it5AmyH3">    if-lez p4, :cond_1d</p><p data-pid="wU1buVSa">    .line 83</p><p data-pid="snlX9QKl">    :cond_c</p><p data-pid="_qV9c19n">    invoke-static {p0}, Lcom/nostra13/universalimageloader/utils/StorageUtils;-&gt;getIndividualCacheDirectory(Landroid/content/Context;)Ljava/io/File;</p><p data-pid="Lz_0NtGj">    move-result-object v1</p><p data-pid="4f8p7Sue">//获取路径准备写入</p><p data-pid="XfDa0nA0">    :try_start_10</p><p data-pid="d7ADfWo9">    new-instance v0, Lcom/nostra13/universalimageloader/cache/disc/impl/ext/LruDiscCache;</p><p data-pid="0SWr0wye">    move-object v3, p1</p><p data-pid="SxlUOWCR">    move-wide v4, p2</p><p data-pid="VyCPZWEA">    move v6, p4</p><p data-pid="vYMBLKpH">    invoke-direct/range {v0 .. v6}, Lcom/nostra13/universalimageloader/cache/disc/impl/ext/LruDiscCache;-&gt;(Ljava/io/File;Ljava/io/File;Lcom/nostra13/universalimageloader/cache/disc/naming/FileNameGenerator;JI)V</p><p data-pid="lOW_mWY7">    :try_end_18</p><p data-pid="I45dCpyZ">    .catch Ljava/io/IOException; {:try_start_10 .. :try_end_18} :catch_19</p><p data-pid="UtmXbOyK">//初始化缓存模块</p><p data-pid="rxYf5841">    :goto_18</p><p data-pid="hgDOzbfv">    return-object v0</p><p data-pid="hce97erL">    .line 87</p><p data-pid="oqndyH8h">    :catch_19</p><p data-pid="MFPioe0v">    move-exception v0</p><p data-pid="EdpyuQrF">    .line 88</p><p data-pid="MaSpS2BP">    invoke-static {v0}, Lcom/nostra13/universalimageloader/utils/L;-&gt;e(Ljava/lang/Throwable;)V</p><p data-pid="urKu_EZm">//异常处理</p><p data-pid="oCDMPTEf">    :cond_1d</p><p data-pid="MfSAdYln">    invoke-static {p0}, Lcom/nostra13/universalimageloader/utils/StorageUtils;-&gt;getCacheDirectory(Landroid/content/Context;)Ljava/io/File;</p><p data-pid="rRL0mHAN">    move-result-object v1</p><p data-pid="6y1tSoFG">//获取缓存路径准备写入</p><p data-pid="pH_lZkkh">    new-instance v0, Lcom/nostra13/universalimageloader/cache/disc/impl/UnlimitedDiscCache;</p><p data-pid="3PKbA0SO">    invoke-direct {v0, v1, v2, p1}, Lcom/nostra13/universalimageloader/cache/disc/impl/UnlimitedDiscCache;-&gt;(Ljava/io/File;Ljava/io/File;Lcom/nostra13/universalimageloader/cache/disc/naming/FileNameGenerator;)V</p><p data-pid="j7QA4Hml">//初始化缓存限制模块</p><p data-pid="3dmF80uD">    goto :goto_18</p><p data-pid="X0DjuAau">.end method</p><br><p data-pid="l8BZJ1Su">至此为止，结论出来了</p><p data-pid="QXH1BHi_">这个开源库用私有目录作为缓存目录，把展示的图片保存在缓存目录下（虽然我不认为这样可以加速加载）</p><p data-pid="hGR5I6U4">然后狗东显示截图的时候调用了开源库，截图就出现在私有目录下了</p><p data-pid="F9Wxtr9h">并没有恶意代码，挺正常的对吧</p><br><br><br><p data-pid="uJNfkIFF">正常你妈啊！你一个金融app要显示我截图干嘛？？？</p><p data-pid="_47bhdRc">正常你妈啊！你一个金融app要显示我截图干嘛？？？</p><p data-pid="lEJzqFBb">正常你妈啊！你一个金融app要显示我截图干嘛？？？</p><p data-pid="5KdkBIMx">开源库作者不背锅，狗东程序员请自裁，指使程序员做出这种feature的产品经理请上断头台。</p>