京东金融窃取截图的简要分析（1）-哪里来的截图监听
<p data-pid="dea6zxZE">懒的排版和组织语言了，就随手写一下</p><p data-pid="rV94ggAF">根据微博上视频里的文件夹名uil-images，直接进dex挖字符串</p><figure><noscript><img src="https://pic3.zhimg.com/v2-61a48e6970db7662ce28460e01bbd45f_720w.png?source=3af55fa1" data-rawwidth="1027" data-rawheight="452" class="origin_image zh-lightbox-thumb" width="1027" data-original="https://pic1.zhimg.com/v2-61a48e6970db7662ce28460e01bbd45f_r.jpg?source=3af55fa1"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='1027'%20height='452'&gt;&lt;/svg&gt;" data-rawwidth="1027" data-rawheight="452" class="origin_image zh-lightbox-thumb lazy" width="1027" data-original="https://pic1.zhimg.com/v2-61a48e6970db7662ce28460e01bbd45f_r.jpg?source=3af55fa1" data-actualsrc="https://pic3.zhimg.com/v2-61a48e6970db7662ce28460e01bbd45f_720w.png?source=3af55fa1"></figure><p data-pid="E9lyweLL">全部来自这个作者为nostra13的开源库</p><p data-pid="kH8n-b1y">去github扒一下</p><figure><noscript><img src="https://pic1.zhimg.com/v2-6e1c1d906485e395960ac6300a1a0807_720w.png?source=3af55fa1" data-rawwidth="1079" data-rawheight="1215" class="origin_image zh-lightbox-thumb" width="1079" data-original="https://pic3.zhimg.com/v2-6e1c1d906485e395960ac6300a1a0807_r.jpg?source=3af55fa1"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='1079'%20height='1215'&gt;&lt;/svg&gt;" data-rawwidth="1079" data-rawheight="1215" class="origin_image zh-lightbox-thumb lazy" width="1079" data-original="https://pic3.zhimg.com/v2-6e1c1d906485e395960ac6300a1a0807_r.jpg?source=3af55fa1" data-actualsrc="https://pic1.zhimg.com/v2-6e1c1d906485e395960ac6300a1a0807_720w.png?source=3af55fa1"></figure><p data-pid="aOu6pwmO">哎哟星星还挺多多嘛，按照道理不应该是开源库的锅啊</p><p data-pid="G-Sh5vqN">接着爬调用开源库的类并过滤关键词screenshot找到了狗东代码的这个位置</p><p data-pid="tnWRSrXQ">Lcom/jd/jrapp/bm/common/screenshot/</p><figure><noscript><img src="https://pica.zhimg.com/v2-923434af36ca167b4b5b8335417a540f_720w.png?source=3af55fa1" data-rawwidth="853" data-rawheight="877" class="origin_image zh-lightbox-thumb" width="853" data-original="https://pic2.zhimg.com/v2-923434af36ca167b4b5b8335417a540f_r.jpg?source=3af55fa1"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='853'%20height='877'&gt;&lt;/svg&gt;" data-rawwidth="853" data-rawheight="877" class="origin_image zh-lightbox-thumb lazy" width="853" data-original="https://pic2.zhimg.com/v2-923434af36ca167b4b5b8335417a540f_r.jpg?source=3af55fa1" data-actualsrc="https://pica.zhimg.com/v2-923434af36ca167b4b5b8335417a540f_720w.png?source=3af55fa1"></figure><p data-pid="mi405b-U">看到一个接收器</p><p data-pid="6L2Dm7mV">拿着这个接收器倒爬，发现在activity基础类里注册了接收器</p><figure><noscript><img src="https://pic3.zhimg.com/v2-82b6f1ece8e784907931efbb8a633ba6_720w.png?source=3af55fa1" data-rawwidth="1080" data-rawheight="1920" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic3.zhimg.com/v2-82b6f1ece8e784907931efbb8a633ba6_r.jpg?source=3af55fa1"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='1080'%20height='1920'&gt;&lt;/svg&gt;" data-rawwidth="1080" data-rawheight="1920" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic3.zhimg.com/v2-82b6f1ece8e784907931efbb8a633ba6_r.jpg?source=3af55fa1" data-actualsrc="https://pic3.zhimg.com/v2-82b6f1ece8e784907931efbb8a633ba6_720w.png?source=3af55fa1"></figure><p data-pid="7Eo7alJB">其中包括一个startlisten方法，再次返回去找这个方法</p><figure><noscript><img src="https://pic3.zhimg.com/v2-38c002f0170c77eaa7b69a2f806472a9_720w.png?source=3af55fa1" data-rawwidth="946" data-rawheight="568" class="origin_image zh-lightbox-thumb" width="946" data-original="https://pic3.zhimg.com/v2-38c002f0170c77eaa7b69a2f806472a9_r.jpg?source=3af55fa1"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='946'%20height='568'&gt;&lt;/svg&gt;" data-rawwidth="946" data-rawheight="568" class="origin_image zh-lightbox-thumb lazy" width="946" data-original="https://pic3.zhimg.com/v2-38c002f0170c77eaa7b69a2f806472a9_r.jpg?source=3af55fa1" data-actualsrc="https://pic3.zhimg.com/v2-38c002f0170c77eaa7b69a2f806472a9_720w.png?source=3af55fa1"></figure><p data-pid="jKZdahCS">这个方法很简短，但里面这个businessshot为什么要带个business字样呢？有点耐人寻味</p><p data-pid="ddyO_eAn">接着去找这个方法</p><figure><noscript><img src="https://pica.zhimg.com/v2-1a5475e7b2c504743901be239302a5ad_720w.png?source=3af55fa1" data-rawwidth="943" data-rawheight="602" class="origin_image zh-lightbox-thumb" width="943" data-original="https://pic2.zhimg.com/v2-1a5475e7b2c504743901be239302a5ad_r.jpg?source=3af55fa1"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='943'%20height='602'&gt;&lt;/svg&gt;" data-rawwidth="943" data-rawheight="602" class="origin_image zh-lightbox-thumb lazy" width="943" data-original="https://pic2.zhimg.com/v2-1a5475e7b2c504743901be239302a5ad_r.jpg?source=3af55fa1" data-actualsrc="https://pica.zhimg.com/v2-1a5475e7b2c504743901be239302a5ad_720w.png?source=3af55fa1"></figure><p data-pid="Swa4vHbW">就一个iput</p><p data-pid="TNQhMamI">因为iput要求附加context，所以肯定存在iget且仅存在于这个类里（包括附属类）</p><p data-pid="u7D0IPRr">在这个类里搜索变量，发现只有onShot方法里有</p><figure><noscript><img src="https://pic2.zhimg.com/v2-be803ce7230ba065cdaae4bcaedfdd86_720w.png?source=3af55fa1" data-rawwidth="1080" data-rawheight="1920" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pica.zhimg.com/v2-be803ce7230ba065cdaae4bcaedfdd86_r.jpg?source=3af55fa1"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='1080'%20height='1920'&gt;&lt;/svg&gt;" data-rawwidth="1080" data-rawheight="1920" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pica.zhimg.com/v2-be803ce7230ba065cdaae4bcaedfdd86_r.jpg?source=3af55fa1" data-actualsrc="https://pic2.zhimg.com/v2-be803ce7230ba065cdaae4bcaedfdd86_720w.png?source=3af55fa1"></figure><p data-pid="39HljgcA">但是按照道理这个方法应该是截屏后去调用的，前面这个注册接收器怎么注册的还是有点迷</p><p data-pid="S65P4PdF">返回基础activity类翻，发现这个</p><p data-pid="cFlR8H26">    invoke-virtual {v0, v1}, Lcom/jd/jrapp/bm/common/screenshot/ScreenShotListenManager;-&gt;setListener(Lcom/jd/jrapp/bm/common/screenshot/ScreenShotListenManager$OnScreenShotListener;)V</p><p data-pid="w4C9ueg4">看样子这个manager类里有•花头</p><p data-pid="bKtB_TO2">发现一个新变量，接着去爬这个变量</p><figure><noscript><img src="https://pic2.zhimg.com/v2-8060370fa6cf287733404b15d4f9c15f_720w.png?source=3af55fa1" data-rawwidth="972" data-rawheight="594" class="origin_image zh-lightbox-thumb" width="972" data-original="https://pic1.zhimg.com/v2-8060370fa6cf287733404b15d4f9c15f_r.jpg?source=3af55fa1"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='972'%20height='594'&gt;&lt;/svg&gt;" data-rawwidth="972" data-rawheight="594" class="origin_image zh-lightbox-thumb lazy" width="972" data-original="https://pic1.zhimg.com/v2-8060370fa6cf287733404b15d4f9c15f_r.jpg?source=3af55fa1" data-actualsrc="https://pic2.zhimg.com/v2-8060370fa6cf287733404b15d4f9c15f_720w.png?source=3af55fa1"></figure><p data-pid="vtSN5X9c">然后发现这个manager里还真有•东西</p><figure><noscript><img src="https://pic2.zhimg.com/v2-c84c90f370603900c432f79aa8ddedcf_720w.png?source=3af55fa1" data-rawwidth="1080" data-rawheight="1920" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic2.zhimg.com/v2-c84c90f370603900c432f79aa8ddedcf_r.jpg?source=3af55fa1"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='1080'%20height='1920'&gt;&lt;/svg&gt;" data-rawwidth="1080" data-rawheight="1920" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic2.zhimg.com/v2-c84c90f370603900c432f79aa8ddedcf_r.jpg?source=3af55fa1" data-actualsrc="https://pic2.zhimg.com/v2-c84c90f370603900c432f79aa8ddedcf_720w.png?source=3af55fa1"></figure><p data-pid="uZO100qN">出现在方法handleMediaRowData里</p><p data-pid="wy8JqqtC">爬这个方法</p><p data-pid="BS30x7_V">发现又在handleMediaContentChange这个方法里</p><p data-pid="fDfcELXM">接着爬</p><p data-pid="ta6ZF110">发现这个access方法</p><figure><noscript><img src="https://pic1.zhimg.com/v2-08ede0b9b7e8acf97a29384511c7531f_720w.png?source=3af55fa1" data-rawwidth="984" data-rawheight="550" class="origin_image zh-lightbox-thumb" width="984" data-original="https://pic2.zhimg.com/v2-08ede0b9b7e8acf97a29384511c7531f_r.jpg?source=3af55fa1"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='984'%20height='550'&gt;&lt;/svg&gt;" data-rawwidth="984" data-rawheight="550" class="origin_image zh-lightbox-thumb lazy" width="984" data-original="https://pic2.zhimg.com/v2-08ede0b9b7e8acf97a29384511c7531f_r.jpg?source=3af55fa1" data-actualsrc="https://pic1.zhimg.com/v2-08ede0b9b7e8acf97a29384511c7531f_720w.png?source=3af55fa1"></figure><p data-pid="Et7KK85L">其中这个方法的p1是个uri</p><p data-pid="d4JUi1Yz">感觉已经快接近真相了</p><p data-pid="nU1hpLp0">在一个附属类里找到了这个access的引用</p><figure><noscript><img src="https://pic1.zhimg.com/v2-1ea33e6c60989f44d6b17d80f8a75271_720w.png?source=3af55fa1" data-rawwidth="1080" data-rawheight="1920" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic3.zhimg.com/v2-1ea33e6c60989f44d6b17d80f8a75271_r.jpg?source=3af55fa1"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='1080'%20height='1920'&gt;&lt;/svg&gt;" data-rawwidth="1080" data-rawheight="1920" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic3.zhimg.com/v2-1ea33e6c60989f44d6b17d80f8a75271_r.jpg?source=3af55fa1" data-actualsrc="https://pic1.zhimg.com/v2-1ea33e6c60989f44d6b17d80f8a75271_720w.png?source=3af55fa1"></figure><p data-pid="j-n1NDCv">类名ScreenShotListenManager$MediaContentObserver，似乎是监控媒体变化</p><p data-pid="Bk8xtZJs">爬这个监听器，找init</p><figure><noscript><img src="https://pic3.zhimg.com/v2-13956d9dda3019b68d009aec384c828c_720w.png?source=3af55fa1" data-rawwidth="1080" data-rawheight="1920" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic3.zhimg.com/v2-13956d9dda3019b68d009aec384c828c_r.jpg?source=3af55fa1"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='1080'%20height='1920'&gt;&lt;/svg&gt;" data-rawwidth="1080" data-rawheight="1920" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic3.zhimg.com/v2-13956d9dda3019b68d009aec384c828c_r.jpg?source=3af55fa1" data-actualsrc="https://pic3.zhimg.com/v2-13956d9dda3019b68d009aec384c828c_720w.png?source=3af55fa1"></figure><p data-pid="_ASR_4uM">找到了init，在startListen方法里</p><p data-pid="Fezk40fh">至此为止，listener部分分析结束</p><br><p data-pid="9uQ4J9P4">接下来要做的是分析这个接收器到底调用开源库做了什么</p><p data-pid="7HfnAsuH">关键代码在</p><p data-pid="0xaNYZ6x">    sget-object v2, Lcom/jd/jrapp/library/imageloader/ImageOptions;-&gt;commonOption:Lcom/nostra13/universalimageloader/core/DisplayImageOptions;</p><p data-pid="XucUb_hN">    invoke-virtual {v1, p1, v0, v2}, Lcom/jd/jrapp/library/imageloader/JDImageLoader;-&gt;displayFile(Ljava/lang/String;Landroid/widget/ImageView;Lcom/nostra13/universalimageloader/core/DisplayImageOptions;)V</p><p data-pid="PoZ816Lb">这个displayFile方法有•意思</p><br><p data-pid="BqB9rR05">请看下回分解<a href="https://zhuanlan.zhihu.com/p/56877625" class="internal"><span class="invisible">https://</span><span class="visible">zhuanlan.zhihu.com/p/56</span><span class="invisible">877625</span><span class="ellipsis"></span></a></p>